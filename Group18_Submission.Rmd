---
title: "Group 18 - R Bootcamp"
author: "Noel Rinke, Yanik Baumann"
date: \today
output: 
  pdf_document:
    toc: true
    toc_depth: 3
    number_sections: true
    includes:
      in_header: "wrap-code.tex"                  # Wraps code (when not fitting on one line)
    latex_engine: xelatex                         # Solves encoding issue
geometry: "left=2cm,right=2cm,top=2cm,bottom=2cm" # Customize margins
biblio-style: apa
bibliography: Sources.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```


# Introduction

Noel Rinke and Yanik Baumann are two students at the Lucerne University of Applied Sciences and Arts studying for a Master's degree in Applied Information and Data Science. Our assignment represents a complete data analysis where we use a wide variety of R functionalities. For this analysis, we use data from Citi Bike New York. 

## Background Information on New York City's Bike-Sharing Scheme

New York City's bike-sharing scheme *Citi Bike* began operating in 2013 [@LyftInc22]. With 19'000 bikes and more than 1'000 stations (as of 2022), Citi Bike is an integral part of New York City's transport network and the largest bike-sharing service in the United States [@LyftInc22]. The bike-sharing scheme consists of a fleet of specifically engineered bicycles that are connected to a network of stations which span with Manhattan, Brooklyn, Queens and the Bronx four of New York City's five boroughs - besides Jersey City and Hoboken.

The popularity and rise of bike sharing services stems from the benefits such services provide: While cars contribute to traffic congestion, greenhouse gas emissions and global warming, bicycles offer an environmentally friendlier, healthier, more economical and less space-consuming transportation alternative.


## Aim of the Analysis

This analysis will show when the most trips are made, whether rain has an influence on the number of trips and where the Citibikes are used most. 


## Datasets used

In order to obtain the intended insights, the analysis required two different data sets: Citi Bike ride-sharing data and weather data.

The data with records on the bicycle rides was obtained from Citi Bike [@CitiBikeNYC22] which provides all data sets since the service began operating in 2013. To represent each season, four different data sets were downloaded for January, April, July, and December, and an equal sample size was drawn from each month in the data preparation section. In addition, it is important to note that the COVID-19 pandemic was thought to be a potential confounding factor, so we specifically chose to use data from 2019, which predated the pandemic.

The second data set used stems from the National Oceanic and Atmospheric Administration [@NOAA22] which is part of the U.S. Department of Commerce. The dataset includes weather data measured at the weather station with the number GHCND:USW00094728 which corresponds to New York City's Central Park. Important to note is that the weather data provided does not include measurements per hour, but per day.


# Installation of Packages

```{r, echo=TRUE, warning=FALSE, message=FALSE}

require(knitr)        # Engine for dynamic report generation
require(dplyr)        # For data manipulation
require(tidyr)        # Provides various important functions that can be used for Data Cleaning
require(broom)        # For summarizing statistical model objects in tidy tibbles
require(lubridate)    # For working with date-times and time-spans
require(skimr)        # For summary statistic
require(ggplot2)      # tidyverse data visualization package
require(ggeasy)       # Series of aliases to commonly used but diff. to remember ggplot2 seq.
require(ggthemes)     # Extra themes, geoms, and scales for 'ggplot2'
require(scales)       # Internal scaling infrastructure to ggplot2 and its functions
require(maps)         # For computing the areas of regions in a projected map
require(ggmap)        # To visualize spatial data & models on top of static maps
require(RColorBrewer) # Color palette
library(gridExtra)    # Provides a number of user-level functions to work with "grid" graphics
library(data.table)   # Widely used for fast aggregation of large datasets
```


# Data Preparation

This chapter describes the import and the preparation of the data sets.


## Data Import

The ride-sharing data provided by the company Lyft includes many millions of observations since 2013. We decided to reduce the size of the data used to a minimum in order to ensure high performance in the analysis. The months of January, April, July and October for the rides of the year 2019 as well as the weather data for the whole year 2019 are imported below.

```{r citibike-import}
citibike_jan19 <- read.csv(file = file.path('C:\\Users\\Yanik\\switchdrive',
'\\SharedOstSchweiz\\R Bootcamp\\Data\\201901-citibike-tripdata.csv'))

citibike_apr19 <- read.csv(file = file.path('C:\\Users\\Yanik\\switchdrive',
'\\SharedOstSchweiz\\R Bootcamp\\Data\\201904-citibike-tripdata.csv'))

citibike_jul19 <- read.csv(file = file.path('C:\\Users\\Yanik\\switchdrive',
'\\SharedOstSchweiz\\R Bootcamp\\Data\\201907-citibike-tripdata.csv'))

citibike_oct19 <- read.csv(file = file.path('C:\\Users\\Yanik\\switchdrive',
'\\SharedOstSchweiz\\R Bootcamp\\Data\\201910-citibike-tripdata.csv'))
```

```{r weather-import}
nyc_weather_2019 <- read.csv(file = file.path('C:\\Users\\Yanik\\switchdrive',
'\\SharedOstSchweiz\\R Bootcamp\\Data\\New York Weather 2019.csv'))
```

## Taking Samples

```{r samples}
citibike_jan19_sample <- sample_n(citibike_jan19, size=1000)
citibike_apr19_sample <- sample_n(citibike_apr19, size=1000)
citibike_jul19_sample <- sample_n(citibike_jul19, size=1000)
citibike_oct19_sample <- sample_n(citibike_oct19, size=1000)
```

## Merge of the Datasets and Creation of derived Variables

The following chunks of code show how the data sets were joined together, how additionally required variables were created and the dataset cleaned by removing irrelevant variables.

| **Created additional variables**                         | **Removed variables**                                    |
|:---------------------------------------------------------|:---------------------------------------------------------|
| *season*, *DATE*, *meantemp*, *raingrouped*,             | *TSUN*, *TAVG*, *AWND*, *STATION*, *NAME*                |
| *Snow_yesno*, *weekdays*, *daytime*, *tripdur_cat*       |                                                          |

Table: Overview of created and removed variables

### Creating the Variable Season

```{r new-var-season}
citibike_jan19_sample <- cbind(citibike_jan19_sample, season='winter')
citibike_apr19_sample <- cbind(citibike_apr19_sample, season='spring')
citibike_jul19_sample <- cbind(citibike_jul19_sample, season='summer')
citibike_oct19_sample <- cbind(citibike_oct19_sample, season='autumn')
```

### Merging the Citibike Datasets

```{r}
citibike_merged_2019 <- rbind(citibike_jan19_sample, citibike_apr19_sample, 
                              citibike_jul19_sample, citibike_oct19_sample)
```

### Adding a seperate Date-Column

```{r}
citibike_merged_2019$DATE <- substr(citibike_merged_2019$starttime, 1, 10)
```

### Cleaning the Weather Dataset

Variables that were considered irrelevant for the analysis were deleted.

```{r}
nyc_weather_cleaned <- subset(nyc_weather_2019, select = -c(TSUN, TAVG, AWND, STATION, NAME))
```

### Joining the Datasets

```{r}
citi_cb <- left_join(citibike_merged_2019, nyc_weather_cleaned, by='DATE')
```

### Calculate Average Temperature

```{r}
citi_cb$meantemp <- (citi_cb$TMAX + citi_cb$TMIN) / 2
```

### Grouping Rain Intensity

```{r}
citi_cb$raingrouped <- ifelse(citi_cb$PRCP == 0, 'no rain',
                       ifelse(citi_cb$PRCP > 0   & citi_cb$PRCP <=2.0, 'weak',
                       ifelse(citi_cb$PRCP >2.0  & citi_cb$PRCP <=10.0, 'moderate',
                       ifelse(citi_cb$PRCP >10.0 & citi_cb$PRCP <=30.0, 'heavy', 'intense'))))
```

### Creating the Variable Snow Yes/No

```{r}
citi_cb$Snow_yesno <- ifelse(citi_cb$SNOW > 0, 'yes', 'no')
```

### Getting the weekdays

```{r}
# Weekdays in english
Sys.setlocale("LC_TIME", "English")

# Define Weekday
citi_cb$weekday <- weekdays(as.Date(citi_cb$DATE))

# Setting correct factor order
citi_cb$weekday <- factor(citi_cb$weekday,levels = c("Monday","Tuesday","Wednesday",
                                                     "Thursday","Friday","Saturday","Sunday"))
```

### Getting Time and Daytimes

```{r}
citi_cb$onlytime <- as.POSIXct(substr(citi_cb$starttime, 12, 19), format="%H:%M:%S")

# Only Hours and Minutes
citi_cb$time     <- strftime(citi_cb$onlytime,format="%H:%M")

# Only Hour
citi_cb$hour     <- as.numeric(substr(citi_cb$time,1,2))

# Set Daytime
citi_cb$daytime  <- ifelse(citi_cb$onlytime <= as.POSIXct("06:00:00",format="%H:%M:%S"), 'night',
                    ifelse(citi_cb$onlytime > as.POSIXct("06:00:00",format="%H:%M:%S") & 
                    citi_cb$onlytime <= as.POSIXct("12:00:00",format="%H:%M:%S"), 'morning',
                    ifelse(citi_cb$onlytime > as.POSIXct("12:00:00",format="%H:%M:%S") & 
                    citi_cb$onlytime <= as.POSIXct("18:00:00",format="%H:%M:%S"), 'afternoon', 
                    ifelse(citi_cb$onlytime > as.POSIXct("18:00:00",format="%H:%M:%S") & 
                    citi_cb$onlytime <= as.POSIXct("24:00:00",format="%H:%M:%S"), 'evening', 'night'))))

# Setting correct factor order
citi_cb$daytime <- factor(citi_cb$daytime,levels = c("morning","afternoon","evening","night"))
```

### Creating Trip Duration Categories

```{r}
citi_cb$tripdur_cat <- ifelse(citi_cb$tripduration <=300, '0 to 5 min',
                       ifelse(citi_cb$tripduration >300 & 
                              citi_cb$tripduration <=900, '5 to 15 min',
                       ifelse(citi_cb$tripduration >900 & 
                              citi_cb$tripduration <=1800, '15 to 30 min',
                       ifelse(citi_cb$tripduration >1800 & 
                              citi_cb$tripduration <=3600, '30 to 60 min', 'over 120 min'))))

# To make sure that the categories are in ascending order
citi_cb$tripdur_cat <- factor(citi_cb$tripdur_cat, levels = c("0 to 5 min", "5 to 15 min", "15 to 30 min", "30 to 60 min", "over 120 min"))
```


# Analysis

## Data Inspection

The first and the last few entries of the data have been checked to make sure the data is valid and complete.
Also it is nice to get an overview of the different variables of the dataset.

```{r, results='asis'}
# Alternative to summary to get an overview of the data frame
# head(citi_cb)
```

```{r}
# Alternative to summary to get an overview of the data frame
# tail(citi_cb)
```

```{r}
# Alternative to summary to get an overview of the data frame
str(citi_cb)
```

```{r}
# Alternative to summary to get an overview of the data frame
skim(citi_cb)
```

## Outlier Detection and Elimination

Outliers can have a large impact on the statistics derived from the dataset, which is why they need to be handled or at least acknowledged. The variable *tripduration* consists of the time (in seconds) a customer rents a bike from Citi Bike until the bike is returned to a station with an empty dock. Therefore, there can be both natural and non-natural outliers. While the non-natural outliers are due to measurement errors (e.g. system failures), natural outliers could be due to customers not returning the rented bike, customers not being able to return the rented bike until the next day, or similar. A boxplot is created to check the distribution of the variable:

```{r, fig.height=3.75}
# Deactivate scientific notation
options(scipen = 999)

# Check if the variable trip duration has outliers
boxplot(citi_cb$tripduration, 
        horizontal=TRUE,
        xlab = "Trip Duration (in Seconds)",
        color = "lightgray")

# citi_cb %>%
#   ggplot(aes(x=tripduration)) +
#   geom_boxplot()
```

The boxplot reveals that the variable *tripduration* contains outliers. There are for example values above 50'000 seconds which corresponds to approximately 15 hours. The fact that bicycles are rented for such long time durations can be considered as interesting information, although it needs to be noted that the pricing model is rather not designed for bike rentals for several hours, not to mention days. Citi Bike provides for instance an *annual membership* as well as a *day pass*. Both provide unlimited limited rides for the corresponding pass lengths. However, if the bike is not returned to a dock within 30 minutes, extra fees apply (extra $4 for each additional 15 minutes - as of 2022). Hence, the purpose of the service is to rent a bike multiple times per day but for less than 30 minutes and if needed by a customer for a longer distance for a few hours.

Before deciding on a threshold for removing outliers, we want to check how many bikes were rented for more than half and hour as well as one, two and five hours.


```{r, fig.height=3.5}
# Histogramm trip duration categories
ggplot(data.frame(citi_cb$tripdur_cat), aes(x=citi_cb$tripdur_cat)) +
  geom_bar(fill='#2980B9') +
  theme(legend.position="none",axis.text.y=element_blank(),plot.title=element_text(hjust=.5)) +
  theme_fivethirtyeight()+
  xlab("Trip Duration Category") +
  ylab("Number of rides")
```

```{r}
# Remove outliers in the variable trip duration
# citi_cb <- subset(citi_cb, tripduration < 43200)
```


## Citi Bike Usage

```{r, fig.height=3}
## Histogramm Daytime
ggplot(data.frame(citi_cb$daytime), aes(x=citi_cb$daytime)) +
  geom_bar(fill='#2980B9') +
  theme(legend.position="none",axis.text.y=element_blank(),plot.title=element_text(hjust=.5)) +
  theme_fivethirtyeight()+
  xlab("Daytime") +
  ylab("Number of rides")
```


### Hourly Distribution of Rides

```{r}
citi_cb %>% ggplot(aes(x=hour,fill=factor(weekday))) +
  scale_fill_manual(values = c('#2980B9', '#2980B9', '#2980B9', '#2980B9', '#2980B9', '#2980B9', '#2980B9')) +
  geom_density(alpha=.2) +
  facet_wrap(~weekday,ncol=1) +
  theme_fivethirtyeight() +
  theme(legend.position="none",axis.text.y=element_blank(),plot.title=element_text(hjust=.5)) + 
  ggtitle(expression(atop("Hourly Distribution of Rides")))
```

## Most and least used Start and End Stations

An important factor for Lyft - the provider of Citi Bike - could be to track the most and least used stations. Stations that are used the most could provide the opportunity to increase the number of bikes and docking stations, and the stations where neither many customers start nor finish their ride could be relocated.

```{r}
# Create a dataframe with a column which counts how often a start station was used
start.station.rank <- data.frame(citi_cb %>%
                                       group_by(start.station.name) %>%
                                       summarize(count.start=n()) %>%
                                       arrange(desc(count.start)))

# Create a dataframe with a column which counts how often an end station was used
end.station.rank <- data.frame(citi_cb %>%
                                     group_by(end.station.name) %>%
                                     summarize(count.end=n()) %>%
                                     arrange(desc(count.end)))


# Combine the start station and end station dataframes
# So that we have for each station the number of bike rented and the number of bikes returned
station_usage <- left_join(x=start.station.rank, y=end.station.rank, by=c("start.station.name"="end.station.name"))

# Check if there are start or end stations which were not used
na_check_start_bef <- sum(is.na(station_usage$count.start))
na_check_end_bef <- sum(is.na(station_usage$count.end))

print(paste0("There are ", na_check_start_bef, " start stations with NA values and ", na_check_end_bef, " end stations with NA values."))

# Replace all NAs with 0 (Stations which no one used should be shown as zero for the subsequent sum)
station_usage <- station_usage %>% 
  mutate_all(~replace(., is.na(.), 0))

# Check if the NA values were successfully replaced
na_check_start_aft <- sum(is.na(station_usage$count.start))
na_check_end_aft <- sum(is.na(station_usage$count.end))

if (na_check_start_aft != 0){
  print(paste0("After replacement, there are ", na_check_start_aft, " start stations with NA values and ", na_check_end_aft, " end stations with NA values.")) 
} else{
  print("Successfully replaced NA values with 0.")}

# Create a new column which shows the combined number of bikes rented and returned
station_usage$station.count.comb <- rowSums(station_usage[, c("count.start", "count.end")])

# Order the dataframe by the combined number (from largest to smallest) to get a ranking
station_usage <- station_usage[order(-station_usage$station.count.comb),]

# Rename columns for improved readability
setnames(station_usage, old = c('start.station.name','count.start', 'count.end', 'station.count.comb'), new = c('Station Name','Bikes rented', 'Bikes returned', 'Total'))

# Check the 10 most and least used stations
kable(head(station_usage, 10), caption="Most used stations")
kable(tail(station_usage, 10), caption="Least used stations")
```

```{r, warning=FALSE, message=FALSE}
# Create variables with the most and least used stations
top10 <- head(station_usage, 10)
least10 <- tail(station_usage, 10)

# Here we add the coordinates to our dataframe
top_10_coord <- left_join(x=top10, y=citi_cb, by=c("Station Name"="start.station.name"))

top10_coord <- top_10_coord %>% 
  select('Station Name','start.station.latitude', 'start.station.longitude', 'Bikes rented', 'Bikes returned', 'Total')

top10_coord <- distinct(top10_coord)

# Here we add the coordinates to our dataframe
least10_coord <- left_join(x=least10, y=citi_cb, by=c("Station Name"="start.station.name"))

least10_coord <- least10_coord %>% 
  select('Station Name','start.station.latitude', 'start.station.longitude', 'Bikes rented', 'Bikes returned', 'Total')

least10_coord <- distinct(least10_coord)

# Set longitudes and latitudes to define map tile for New York City
bbox <- c(left = -74.1, bottom = 40.65, right = -73.875, top = 40.825)
top10_map <- ggmap(get_stamenmap(bbox, zoom = 12, maptype = "toner-lite")) +
                geom_point(data=top10_coord, 
                aes(x=start.station.longitude, 
                    y=start.station.latitude),
                color = 'red', size = 2, alpha = 0.5) +
                theme_update(plot.title = element_text(hjust = 0.5)) +
                ggtitle("The 10 most used Stations") +
                theme(axis.line = element_blank(),    # Remove axis line
                      axis.text = element_blank(),    # Remove axis text
                      axis.ticks = element_blank(),   # Remove axis ticks
                      plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), 'lines')) +
                xlab('') +                            # Remove text on x-axis
                ylab('')                              # Remove text on y-axis

least10_map <- ggmap(get_stamenmap(bbox, zoom = 12, maptype = "toner-lite")) +
                geom_point(data=least10_coord, 
                aes(x=start.station.longitude, 
                    y=start.station.latitude),
                color = 'red', size = 2, alpha = 0.5) +
                theme_update(plot.title = element_text(hjust = 0.5)) +
                ggtitle("The 10 least used Stations") +
                  theme(axis.line = element_blank(),  # Remove axis line
                      axis.text = element_blank(),    # Remove axis text
                      axis.ticks = element_blank(),   # Remove axis ticks
                      plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), 'lines')) +
                xlab('') +                            # Remove text on x-axis
                ylab('')                              # Remove text on y-axis

# Show the two maps side by side
grid.arrange(top10_map, least10_map, ncol=2)
```

The two maps show that the stations in Manhattan close to the Broadway are used the most. The stations in Brooklyn, on the other hand, are utilised very rarely. It is particularly important to mention here that this is based on a small sample. The analysis should be repeated with a larger number of data and over several periods of time.

## Identifiying the Popularity of different Areas in New York City

The map shows by density how strongly the concentration of started bike rentals is distributed across the city. The denser the colour, the higher the concentration of started rides. 

```{r, warning=FALSE, message=FALSE}
# Set longitudes and latitudes to define map tile for New York City
bbox <- c(left = -74.1, bottom = 40.65, right = -73.875, top = 40.825)

# Create density map for start stations
start_station_dens <- ggmap(get_stamenmap(bbox, zoom = 12, maptype = "toner-lite")) +
  stat_density_2d(
    data = citi_cb,
    aes(x=start.station.longitude, y=start.station.latitude, fill= ..level..),
    alpha = .15,
    bins = 18,
    geom = "polygon") +
  scale_fill_gradientn(colors = brewer.pal(7, "YlGnBu")) + # library RColorbrewer
  ggtitle(label = "Start Station Density") +
  theme(plot.title = element_text(hjust = 0.5)) +          # Center the plot title
  xlab("Longitude") +
  ylab("Latitude")

# Create density map for end stations
end_station_dens <- ggmap(get_stamenmap(bbox, zoom = 12, maptype = "toner-lite")) +
  stat_density_2d(
    data = citi_cb, 
    aes(x=end.station.longitude, y=end.station.latitude, fill= ..level..),
    alpha = .15,
    bins = 18,
    geom = "polygon") +
  scale_fill_gradientn(colors = brewer.pal(7, "YlGnBu")) + # library RColorbrewer
  ggtitle(label = "End Station Density") +
  theme(plot.title = element_text(hjust = 0.5)) +          # Center the plot title
  xlab("Longitude") +
  ylab("Latitude")  

start_station_dens
end_station_dens
```


## Influence of Meteorological Factors


### Influence of Temperature

```{r}
# How strong is the effect of the average daily temperature on the trip duration?
ggplot(citi_cb, aes(x=meantemp, y=tripduration)) +
  geom_point(color='#2980B9') + 
  geom_smooth(method=lm, se=FALSE, fullrange=TRUE, color='#2C3E50') +
  ggtitle(label="Effect of Average daily Temperature on Trip Duration") +
  ggeasy::easy_center_title() +
  xlab("Average daily temperature") +
  ylab("Trip duration (in seconds)")

# Spearman because there are two quantitative variables
cor(x=citi_cb$meantemp, y=citi_cb$tripduration, method="spearman")

```


### Influence of Precipitation

```{r}
# How strong is the effect of precipitation on the number of trips?
# Calculation for each category of precipitation how often it rained
rain_cat_freq <- citi_cb %>% 
  group_by(raingrouped) %>%
  summarise(counts = n())

# Plot of the result
ggplot(rain_cat_freq, aes(x = raingrouped, y = counts)) +
  geom_bar(fill = "#0073C2FF", 
           stat = "identity") +
  geom_text(aes(label = counts), 
            vjust = -0.3) + # Label above bar
  xlab("Rain Category") +
  ylab("Number of Rides")
  
```

```{r, results="asis"}
# How strong is the effect of precipitation on the trip duration?
ggplot(citi_cb, aes(x=PRCP, y=tripduration)) +
  geom_point(color='#2980B9') + 
  geom_smooth(method=lm, se=FALSE, fullrange=TRUE, color='#2C3E50') +
  ggtitle(label="Effect of Precipitation on Trip Duration") +
  ggeasy::easy_center_title() +
  xlab("Precipitation (in mm)") +
  ylab("Trip duration (in seconds)")

cor_tripduration_precipitation <- round(cor(x=citi_cb$PRCP, 
                                            y=citi_cb$tripduration, 
                                            method="spearman"),2)
print(paste0("Interpretation: For every mm of precipitation, the time a customer rents a bike changes by ", cor_tripduration_precipitation, " seconds."))

```

### Influence of temperature on tripduration (in seconds)

Using the analysis of variance, we would like to see whether the factors of average temperature and rain have an influence on the length of a trip.

```{r}
model <- aov(tripduration ~ meantemp + PRCP, data = citi_cb)
summary(model)
```


# Results

Most rides are done in the afternoon. During the week, peaks are measured between 08:00 - 09:00 and between 17:00 - 18:00. On weekends, the busiest time is between 11:00 - 16:00. Citibike New York is especially popular in the Manhattan borough. 
Rain has a strong influence on the number of rides per day. When there is no rain, the Citibikes are used much more often. However, the rain has no significant influence on the duration of the trips. 

# Lessons Learned

* To display maps in a pdf document or any other format except HTML, static maps need to be used. Leaflet - which was used initially - is a JavaScript library for building interactive maps for the web and hence not static. There is a workaround with generating image files which is however not recommended because libraries should be used what they are built for.

# Sources


