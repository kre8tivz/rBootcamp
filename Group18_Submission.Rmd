---
title: "Group 18 - R Bootcamp"
author: "Noel Rinke, Yanik Baumann"
date: \today
output: 
  pdf_document:
    toc: true
    toc_depth: 3
    number_sections: true
    includes:
      in_header: "wrap-code.tex"                  # Wraps code (when not fitting on one line)
    latex_engine: xelatex                         # Solves encoding issue
geometry: "left=2cm,right=2cm,top=2cm,bottom=2cm" # Customize margins
biblio-style: apa
bibliography: Sources.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```


# Introduction

Noel Rinke and Yanik Baumann are two students at the Lucerne University of Applied Sciences and Arts studying for a Master's degree in Applied Information and Data Science. Our assignment represents a complete data analysis where we use a wide variety of R functionalities. For this analysis, we use data from Citibike New York. 

## Background Information on New York City's Bike-Sharing Scheme

New York City's bike-sharing scheme *Citi Bike* began operating in 2013 [@LyftInc22]. With 19'000 bikes and more than 1'000 stations (as of 2022), Citi Bike is an integral part of New York City's transport network and the largest bike-sharing service in the United States [@LyftInc22]. The bike-sharing scheme consists of a fleet of specifically engineered bicycles that are connected to a network of stations which span with Manhattan, Brooklyn, Queens and the Bronx four of New York City's five boroughs - besides Jersey City and Hoboken.

The popularity and rise of bike sharing services stems from the benefits such services provide: While cars contribute to traffic congestion, greenhouse gas emissions and global warming, bicycles offer an environmentally friendlier, healthier, more economical and less space-consuming transportation alternative.


## Aim of the Analysis

blabla


## Datasets used

In order to obtain the intended insights, the analysis required two different datasets: Citi Bike ride-sharing data and weather data.

The data with records on the bicycle rides was obtained from Citi Bike which provides all datasets since the service began operating in 2013. To represent each season, four different data sets were downloaded for January, April, July, and December, and an equal sample size was drawn from each month in the data preparation section. In addition, it is important to note that the Covid 19 pandemic was thought to be a potential confounding factor, so we specifically chose to use data from 2019, which predated the pandemic.

The second dataset used stems from the National Oceanic and Atmospheric Administration which is part of the U.S. Department of Commerce. The dataset includes weather data measured at the weather station with the number GHCND:USW00094728 which corresponds to New York City's Central Park. Important to note is that the weather data provided does not include measurements per hour, but per day.


# Installation of Packages

```{r, echo=TRUE, warning=FALSE, message=FALSE}

require(knitr)        # Engine for dynamic report generation
require(dplyr)        # For data manipulation
require(tidyr)
require(broom)        # For summarizing statistical model objects in tidy tibbles
require(lubridate)    # For working with date-times and time-spans
require(skimr)        # For summary statistic
require(ggplot2)      # tidyverse data visualization package
require(ggeasy)       # Series of aliases to commonly used but difficult to remember 
                        # 'ggplot2' sequences
require(ggthemes)     # Extra themes, geoms, and scales for 'ggplot2'
require(scales)       # Internal scaling infrastructure to ggplot2 and its functions
require(maps)         # For computing the areas of regions in a projected map
require(ggmap)        # To visualize spatial data & models on top of static maps
require(RColorBrewer) # Color palette

```


# Data Preparation

This chapter describes the import and the preparation of the data sets.


## Data Import

The ride-sharing data provided by Citi Bike includes many millions of observations since 2013. We decided to reduce the size of the data used to a minimum in order to ensure high performance in the analysis. The months of January, April, July and October for the rides of the year 2019 as well as the weather data for the whole year 2019 are imported below.

```{r citibike-import}
citibike_jan19 <- read.csv(file = file.path('C:\\Users\\noelr\\switchdrive',
'\\SharedOstSchweiz\\R Bootcamp\\Data\\201901-citibike-tripdata.csv'))

citibike_apr19 <- read.csv(file = file.path('C:\\Users\\noelr\\switchdrive',
'\\SharedOstSchweiz\\R Bootcamp\\Data\\201904-citibike-tripdata.csv'))

citibike_jul19 <- read.csv(file = file.path('C:\\Users\\noelr\\switchdrive',
'\\SharedOstSchweiz\\R Bootcamp\\Data\\201907-citibike-tripdata.csv'))

citibike_oct19 <- read.csv(file = file.path('C:\\Users\\noelr\\switchdrive',
'\\SharedOstSchweiz\\R Bootcamp\\Data\\201910-citibike-tripdata.csv'))

```

```{r weather-import}
nyc_weather_2019 <- read.csv(file = file.path('C:\\Users\\noelr\\switchdrive',
'\\SharedOstSchweiz\\R Bootcamp\\Data\\New York Weather 2019.csv'))

```

## Taking Samples

```{r samples}
citibike_jan19_sample <- sample_n(citibike_jan19, size=1000)
citibike_apr19_sample <- sample_n(citibike_apr19, size=1000)
citibike_jul19_sample <- sample_n(citibike_jul19, size=1000)
citibike_oct19_sample <- sample_n(citibike_oct19, size=1000)

```

## Merge of the Datasets and Creation of derived Variables

The following chunks of code show how the data sets were joined together, how additionally required variables were created and the dataset cleaned by removing irrelevant variables.

| **Created additional variables**                         | **Removed variables**                                    |
|:---------------------------------------------------------|:---------------------------------------------------------|
| *season*, *DATE*, *meantemp*, *raingrouped*,             | *TSUN*, *TAVG*, *AWND*                                   |
| *Snow_yesno*, *weekdays*, *daytime*, *tripduration_cat*  |                                                          |

### Variable Season

```{r new-var-season}
citibike_jan19_sample <- cbind(citibike_jan19_sample, season='winter')
citibike_apr19_sample <- cbind(citibike_apr19_sample, season='spring')
citibike_jul19_sample <- cbind(citibike_jul19_sample, season='summer')
citibike_oct19_sample <- cbind(citibike_oct19_sample, season='autumn')

```

### Merging the Citibike Datasets

```{r}
citibike_merged_2019 <- rbind(citibike_jan19_sample, citibike_apr19_sample, citibike_jul19_sample, citibike_oct19_sample)

```

### Adding a seperate Date-Column

```{r}
citibike_merged_2019$DATE <- substr(citibike_merged_2019$starttime, 1, 10)

```

### Cleaning the Weather Dataset

Variables that were considered irrelevant for the analysis were deleted.

```{r}
nyc_weather_cleaned <- subset(nyc_weather_2019, select = -c(TSUN, TAVG, AWND))

```

### Joining the Datasets

```{r}
citi_cb <- left_join(citibike_merged_2019, nyc_weather_cleaned, by='DATE')
```

### Calculate Average Temperature

```{r}
citi_cb$meantemp <- (citi_cb$TMAX + citi_cb$TMIN) / 2
```

### Grouping Rain Intensity

```{r}
citi_cb$raingrouped <- ifelse(citi_cb$PRCP == 0, 'no rain',
                       ifelse(citi_cb$PRCP > 0   & citi_cb$PRCP <=2.0, 'weak',
                       ifelse(citi_cb$PRCP >2.0  & citi_cb$PRCP <=10.0, 'moderate',
                       ifelse(citi_cb$PRCP >10.0 & citi_cb$PRCP <=30.0, 'heavy', 'intense'))))
```

### Creating the Variable Snow Yes/No

```{r}
citi_cb$Snow_yesno <- ifelse(citi_cb$SNOW > 0, 'yes', 'no')
```

### Getting the weekdays

```{r}
# Weekdays in english
Sys.setlocale("LC_TIME", "English")

# Define Weekday
citi_cb$weekday <- weekdays(as.Date(citi_cb$DATE))

# Setting correct factor order
citi_cb$weekday <- factor(citi_cb$weekday,levels = c("Monday","Tuesday","Wednesday",
                                                     "Thursday","Friday","Saturday","Sunday"))
```

### Getting Time and Daytimes

```{r}
citi_cb$onlytime <- as.POSIXct(substr(citi_cb$starttime, 12, 19), format="%H:%M:%S")

# Only Hours and Minutes
citi_cb$time     <- strftime(citi_cb$onlytime,format="%H:%M")

# Only Hour
citi_cb$hour     <- as.numeric(substr(citi_cb$time,1,2))

# Set Daytime
citi_cb$daytime  <- ifelse(citi_cb$onlytime <= as.POSIXct("06:00:00",format="%H:%M:%S"), 'night',
                    ifelse(citi_cb$onlytime > as.POSIXct("06:00:00",format="%H:%M:%S") & 
                    citi_cb$onlytime <= as.POSIXct("12:00:00",format="%H:%M:%S"), 'morning',
                    ifelse(citi_cb$onlytime > as.POSIXct("12:00:00",format="%H:%M:%S") & 
                    citi_cb$onlytime <= as.POSIXct("18:00:00",format="%H:%M:%S"), 'afternoon', 
                    ifelse(citi_cb$onlytime > as.POSIXct("18:00:00",format="%H:%M:%S") & 
                    citi_cb$onlytime <= as.POSIXct("24:00:00",format="%H:%M:%S"), 'evening', 'night'))))

# Setting correct factor order
citi_cb$daytime <- factor(citi_cb$daytime,levels = c("morning","afternoon","evening","night"))
```

### Setting trip duration groups

```{r}
citi_cb$tripduration_cat <- ifelse(citi_cb$tripduration <=300, '0 to 5 min',
                            ifelse(citi_cb$tripduration >300 & citi_cb$tripduration <=900, '5 to 15 min',
                            ifelse(citi_cb$tripduration >900 & citi_cb$tripduration <=1800, '15 to 30 min',
                            ifelse(citi_cb$tripduration >1800 &
                                   citi_cb$tripduration <=3600, '30 to 60 min','over 60 min'))))
```


## Outlier Detection and Elimination

Outliers can have a large impact on the statistics derived from the dataset, which is why they need to be handled or at least acknowledged. The variable *tripduration* consists of the time (in seconds) a customer rents a bike from Citi Bike until the bike is returned to a station with an empty dock. Therefore, there can be both natural and non-natural outliers. While the non-natural outliers are due to measurement errors (e.g. system failures), natural outliers could be due to customers not returning the rented bike, customers not being able to return the rented bike until the next day, or similar.

```{r}
#Deactivate scientific notation
options(scipen = 999)

# Check if the variable trip duration has outliers
boxplot(citi_cb$tripduration, horizontal=TRUE)

```

The boxplot reveals that the variable *tripduration* contains two extreme outliers - one of about 64 hours and the other of about 278 hours. The fact that bicycles are rented for more than 24 hours can be considered as important information, but renting for several days is not in line with the purpose and design of the service. Although the cause of these outliers is not known, we decided to remove all outliers above 12 hours.

```{r}
# Remove outliers in the variable trip duration
citi_cb <- subset(citi_cb, tripduration < 43200)
boxplot(citi_cb$tripduration, horizontal=TRUE)

```


# Analysis

## Data Inspection

```{r}
# Alternative to summary to get an overview of the data frame
skim(citi_cb)

```

```{r}
skim(citi_cb) %>%
  dplyr::select(skim_type, skim_variable, n_missing)

```


## Most and least used Start and End Stations

An important factor for Lyft - the provider of Citi Bike - could be to track the most and least used stations. Stations that are used the most could provide the opportunity to increase the number of docking stations, and the stations where neither many customers start nor finish their ride could be relocated.

```{r, echo=FALSE, results='hide'}
# The 10 most popular start stations
start.station.rank.t10 <- data.frame(citi_cb %>%
                             group_by(start.station.name) %>%
                             summarize(count=n()) %>%
                             arrange(desc(count))) %>%
                             head(10)
start.station.rank.t10
```

```{r, echo=FALSE, results='hide'}
# The 10 least popular start stations
start.station.rank.l10 <- data.frame(citi_cb %>%
                              group_by(start.station.name) %>% 
                              summarize(count=n()) %>% 
                              arrange(count)) %>% 
                              head(10)

start.station.rank.l10
```

```{r, echo=FALSE, results='hide'}
# The 10 most popular end stations
end.station.rank.t10 <- data.frame(citi_cb %>%
                             group_by(end.station.name) %>%
                             summarize(count=n()) %>%
                             arrange(desc(count))) %>% 
                             head(10)

end.station.rank.t10

```

```{r, echo=FALSE, results='hide'}
# The 10 least popular end stations
end.station.rank.l10 <- data.frame(citi_cb %>%
                              group_by(end.station.name) %>% 
                              summarize(count=n()) %>% 
                              arrange(count)) %>% 
                              head(10)

end.station.rank.l10

```


## Identifiying the Popularity of different Areas in New York City

The map shows by density how strongly the concentration of started bike rentals is distributed across the city. The denser the colour, the higher the concentration of started rides. 

```{r, warning=FALSE, message=FALSE}
# Define longitudes and latitudes for map
bbox <- c(left = -74.1, bottom = 40.65, right = -73.875, top = 40.825)

# Create density map
density_start <- ggmap(get_stamenmap(bbox, zoom = 12, maptype = "toner-lite")) +
  stat_density_2d(
    data = citi_cb, 
    aes(x=start.station.longitude, y=start.station.latitude, fill= ..level..),
    alpha = .15,
    bins = 18,
    geom = "polygon") +
  scale_fill_gradientn(colors = brewer.pal(7, "YlGnBu")) + # library RColorbrewer
  ggtitle(label = "Density Map: Start Station") +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab("Longitude") +
  ylab("Latitude")
  
```

```{r, warning=FALSE, message=FALSE}
# Create density map
density_end <- ggmap(get_stamenmap(bbox, zoom = 12, maptype = "toner-lite")) +
  stat_density_2d(
    data = citi_cb, 
    aes(x=end.station.longitude, y=end.station.latitude, fill= ..level..),
    alpha = .15,
    bins = 18,
    geom = "polygon") +
  scale_fill_gradientn(colors = brewer.pal(7, "YlGnBu")) + # library RColorbrewer
  ggtitle(label = "Density Map: End Stations") +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab("Longitude") +
  ylab("Latitude")
  
```

```{r}
library(gridExtra)

grid.arrange(density_start, density_end, ncol=2)
```


## Influence of Meteorological Factors


### Influence of Temperature

```{r}
## How strong is the effect of the average daily temperature on the trip duration?
ggplot(citi_cb, aes(x=meantemp, y=tripduration)) +
  geom_point(color='#2980B9') + 
  geom_smooth(method=lm, se=FALSE, fullrange=TRUE, color='#2C3E50') +
  ggtitle(label="Effect of Average daily Temperature on Trip Duration") +
  ggeasy::easy_center_title() +
  xlab("Average daily temperature") +
  ylab("Trip duration (in seconds)")

# Spearman because there are two quantitative variables
cor(x=citi_cb$meantemp, y=citi_cb$tripduration, method="spearman")

```


### Influence of Precipitation

```{r}
# How strong is the effect of precipitation on the number of trips?
# Calculation for each category of precipitation how often it rained
rain_cat_freq <- citi_cb %>% 
  group_by(raingrouped) %>%
  summarise(counts = n())

# Plot of the result
ggplot(rain_cat_freq, aes(x = raingrouped, y = counts)) +
  geom_bar(fill = "#0073C2FF", 
           stat = "identity") +
  geom_text(aes(label = counts), 
            vjust = -0.3) + # Label above bar
  xlab("Rain Category") +
  ylab("Number of Rides")
  
```

```{r, results="asis"}
## How strong is the effect of precipitation on the trip duration?
ggplot(citi_cb, aes(x=PRCP, y=tripduration)) +
  geom_point(color='#2980B9') + 
  geom_smooth(method=lm, se=FALSE, fullrange=TRUE, color='#2C3E50') +
  ggtitle(label="Effect of Precipitation on Trip Duration") +
  ggeasy::easy_center_title() +
  xlab("Precipitation (in mm)") +
  ylab("Trip duration (in seconds)")

cor_tripduration_precipitation <- round(cor(x=citi_cb$PRCP, 
                                            y=citi_cb$tripduration, 
                                            method="spearman"),2)
print(paste0("Interpretation: For every mm of precipitation, the time a customer rents a bike changes by ", cor_tripduration_precipitation, " seconds."))

```


### Influence of Snowfall and Snow Depth



# Results


# Lessons Learned

* To display maps in a pdf document or any other format except HTML, static maps need to be used. Leaflet - which was used initially - is a JavaScript library for building interactive maps for the web and hence not static. There is a workaround with generating image files which is however not recommended because libraries should be used what they are built for.

# Sources


